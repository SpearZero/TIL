## 시간 차원의 모델링

### 이벤트 소싱 도메인 모델
- 도메인 모델
    - 애그리게이트의 상태 표현 방식을 유지 관리하고 선택 도메인 이벤트를 내보낸다.
- 이벤트 소싱 도메인 모델
    - 애그리게이트의 수명주기를 모델링하기 위해 독점적으로 도메인 이벤트를 사용한다.

이벤트 소싱 애그리게이트의 작업 단계
- 애그리게이트의 도메인 이벤트를 로드한다.
- 이벤트를 비즈니스 의사결정을 내리는 데 사용할 수 있는 상태로 프로젝션해서 상태 표현을 재구성
- 애그리게이트의 명령을 실행하여 비즈니스 로직을 실행하고 결과적으로 새로운 도메인 이벤트를 생성
- 새 도메인 이벤트를 이벤트 스토어에 커밋

티켓의 예시
- 관련 티켓의 이벤트를 로드
- 애그리게이트의 인스턴스를 리하이드레이션
    - 저장된 이벤트를 순서대로 재생해 현재 상태로 재구성
- 관련 명령 호출
- 변경사항을 데이터베이스에 다시 저장

#### 이벤트 소싱의 장점
- 시간 여행
    - 애그리게이트의 모든 과거 상태를 필요할 때 언제든지 재구성 가능
    - 시스템의 동작을 분석하고, 시스템의 의사 결정을 검사하고, 비즈니스 로직을 최적화 할 때 필요
    - 애그리게이트를 정확히 버그가 관찰됐을 때의 상태로 되돌릴 수 있다.
- 심오한 통찰력
    - 시스템의 상태와 동작에 대한 깊은 통찰력 제공
    - 이벤트를 다른 상태 표현 방식으로 변환할 수 있는 유연한 모델 제공
    - 기존 이벤트의 데이터를 활용하여 추가 통찰력을 제공할 새로운 프로젝션 방법을 언제든지 추가할 수 있다.
- 감사 로그
    - 감사 로그(audit log) 제공
    - 화폐 또는 금전 거래를 관리하는 시스템에 잘 이용된다.
- 고급 낙관적 동시성 제어
    - 고급 낙관적 동시성 모델은 읽기 데이터가 기록되는 동안 다른 프로세스에 의해 덮어쓰여지는 경우 예외를 발생시킴
    - 이벤트 스토어에 동시에 추가된 정확한 이벤트를 추출하고 새로운 이벤트가 시도된 작업과 충돌하는지, 또는 추가 이벤트가 관련이 없고 계속 진행하는 것이 안전한지에 대해 비즈니스 도메인 주도 의사결정을 내릴 수 있음

#### 이벤트 소싱의 단점
- 학습의 난이도가 존재
- 모델의 진화
    - 이벤트 소싱 모델을 발전시키는 것은 어려울 수 있다. 이벤트의 스키마를 조정하기가 쉽지 않다. 
- 아키텍처의 복잡성
    - 이벤트 소싱을 구현하면 수많은 아키텍처의 '유동적인 부분'이 도입되어 전체 설계가 더 복잡해진다.

### 자주 묻는 질문

#### 성능
- 이벤트에서 애그리게이트 상태를 재구성하면 시스템 성능에 부정적인 영향을 준다. 이벤트가 추가되면서 성능이 저하된다. 이것이 어떻게 작동할 수 있을까?
    - 애그리게이트의 이벤트가 상당히 많을 경우 스냅숏 패턴 사용
        - 스냅숏 캐시에 저장된 스냅숏 가져오기 + 이벤트 스토어에서 마지막 스냅숏 뒤에 추가된 이벤트 가져오기
        - 비동기적으로 스냅숏을 생성해야 한다.
- 이 모델은 엄청난 양의 데이터를 생성한다. 확장할 수 있을까?
    - 이벤트 스토어를 애그리게이트 ID로 분할하여 샤딩
    - 애그리게이트의 인스턴스에 속하는 모든 이벤트들은 단일 샤드(shard)에 있어야 한다.

#### 데이터 삭제
- 이벤트 스토어는 추가 전용 데이터베이스지만 물리적으로 데이터를 삭제해야 하는 경우에는 어떻게 할까?
    - 페이로드 패턴 사용
        - 민감 정보는 암호화된 방식으로 이벤트에 포함
        - 암호화 키는 외부 키 저장소에 저장
            - 키: 특정 애그리게이트의 ID
            - 값: 암호화 키
        - 민감 데이터를 삭제해야 하는 경우 키 저장소에서 암호화 키 삭제
            - 이제 민감 정보에 접근할 수 없음

### 결론
- 이벤트 소싱 도메인 모델에서 애그리게이트 상태에 대한 모든 변경사항은 일련의 도메인 이벤트로 표현
- 도메인 이벤트는 애그리게이트의 현재 상태를 프로젝션하는 데 사용 가능
- 이벤트 기반 모델은 이벤트를 특정 작업에 최적화된 여러 표현 모델로 프로젝션 할 수 있는 유연성 제공