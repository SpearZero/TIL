## 진화하는 설계 의사결정
비즈니스 도메인의 요구사항에 잘 맞는 소프트웨어를 설계할 때, 변경 사항을 제대로 관리하지 않으면 아무리 정교하게 잘 설계했어도 결국 유지보수하고 개선하는 일은 고된 일이 될 것이다.

### 도메인 변경
세 가지 유형의 비즈니스 하위 도메인
- 핵심
    - 기업의 경쟁 우위를 확보하기 위해 경쟁자와 다르게 수행하는 활동
- 지원
    - 회사가 경쟁자와 다르게 행동하고 있지만 경쟁 우위를 제공하지 않는 활동
- 일반
    - 모든 회사가 같은 방식으로 하는 일

비즈니스 하위 도메인과 유형을 식별하는 것도 중요하지만 하위 도메인의 진화에 주의를 기울이는것도 중요하다.

변화의 예시

- 핵심 → 일반
    - 경쟁 우위로 간주 되었던 것이 모든 경쟁업체에서 사용할 수 있는 상품이 되었을 경우
- 일반 → 핵심
    - 상용 솔루션을 자체 구현으로 교체해서 경쟁우위를 확보하는 경우
    - 아마존의 경우 인프라를 관리하는 방법을 '재창조'하여 AWS를 만들었음
- 지원 → 일반
    - 사내 솔루션을 버리고 오픈 소스 솔루션을 연동하는 경우
- 지원 → 핵심
    - 회사에서 비용을 줄이거나 추가 수익을 창출하는 방식으로 지원 로직을 최적화하는 방법을 찾는 경우
    - 전조증상
        - 원래 지원 도메인은 회사 이익과 크게 관련이 없어 단순해야 한다. 그런데 로직이 복잡해진다면, 그 영역이 핵심 도메인의 성격을 띠기 시작하는 전조다.
- 핵심 → 지원
    - 복잡성에 비해 수익성이 없는 경우
- 일반 → 지원
    - 복잡성 대비 얻는 이점을 얻을수 없는 경우

### 전략적 설계 문제
하위 도메인의 유형 변화는 바운디드 컨텍스트와 통합 패턴 선택에 직접적인 영향을 미친다.
- 핵심 도메인은 충돌 방지 계층이나 오픈 호스트 서비스처럼 모델을 보호하는 패턴이 필요하다.
- 지원,일반 도메인은 분리형 노선 같은 느슨한 통합 패턴이 적합하다.

하위 도메인이 핵심으로 격상되면, 더 이상 기능을 여러 팀이 따로 개발할 수 없으며 필연적으로 사용자-제공자 관계를 기반으로 단일 팀에서만 구현해야 한다.

또한 도메인 유형 변화는 구현 전략에도 영향을 준다.
- 핵심 도메인: 사내에 깊이 있는 지식이 필요하므로 직접 개발해야 한다.
- 지원/일반 도메인: 외부 위탁 또는 새 인력의 훈련용으로도 활용 가능하다.

### 전술적 설계 문제
비즈니스가 어떻게 변화할지 예측할 수 없기 때문에, 구현 전략이 바뀌는 것은 자연스러운 일이다.
현재 상황에 가장 적합한 설계를 선택하고, 필요할 때 개선하는 유연성이 중요하다.

비즈니스 로직을 의도적으로 모델링하고, 가능한 설계 옵션과 그 차이점을 충분히 이해하고 있다면
현재의 디자인 패턴을 다른 패턴으로 무리 없이 마이그레이션할 수 있다.

- 트랜잭션 스크립트 → 액티브 레코드
    - 트랜잭션 스크립트에서 데이터 작업이 어려워지면 레코드 패턴으로 리팩터링
    - 복잡한 자료구조를 찾아 액티브 레코드 객체에 캡슐화
    - 데이터베이스에 직접 접근하는 대신 액티브 레코드를 사용하여 모델과 구조를 추상화
- 액티브 레코드 → 도메인 모델
    - 액티브 레코드를 조작하는 비즈니스 로직이 복잡해지고 불일치 및 중복 사례가 많아진다면 도메인 모델 패턴으로 리팩터링
    - 변환 순서
        1. 밸류 오브젝트 식별
        2. 자료구조를 분석하고 트랜잭션 경계 찾기
        3. 애그리게이트 경계 정의
            - 상태 변경 로직이 모여야 할 객체 경계를 찾는다.
            - 강한 일관성이 필요한 최소 데이터 범위를 애그리게이트로 설정한다.
            - 외부에는 루트만 공개하고 내부 객체는 캡슐화한다.
        4. 애그리게이트에 대해 루트 또는 퍼블릭 인터페이스의 엔드포인트를 식별한다.
- 도메인 모델 → 이벤트 소싱 도메인 모델
    - 애그리게이트 경계가 잘 잡혀 있다면, 상태를 직접 변경하는 대신 도메인 이벤트로 상태를 구성하는 방식으로 바꿔 이벤트 소싱 모델로 전환할 수 있다.
    - 가장 큰 어려움은 기존 이력 부재로, 과거 이벤트를 추론해 생성하거나 마이그레이션 전용 이벤트를 만들어 해결해야 한다.

### 조직 변화
- 바운디드 컨텍스트는 한 팀에서만 구현할 수 있다.
    - 새 개발팀을 추가하면 기존의 더 넓은 바운디드 컨텍스트 경계가 더 작게 분할되어 각 팀이 고유한 바운디드 컨텍스트에서 작업할 수 있다.
- 바운디드 컨텍스트에 대한 작업이 다른 지역으로 이동할 수 있다. (개발 팀이 여러 지역)
    - 팀의 협업에 부정적인 영향을 줄 수도 있음
- 파트너십에서 사용자 → 제공자
    - 파트너십 패턴은 팀 간의 강력한 의사소통과 협업을 전제로 하지만, 바운디드 컨텍스트에 대한 작업이 다른 지역으로 이동되면 사용자 → 제공자 관계로 이동하는 것이 적절할 수 있다.
- 사용자 → 제공자에서 분리형 노선
    - 지리적 거리나 조직 내부 정치로 인해 발생 이 경우 분리형 노선이 더 비용 효과적일 수 있다.

### 도메인 지식
도메인 주도 설계에서 가장 중요한 것은 도메인 지식을 지속적으로 습득하고 갱신하는 것이다. 특히 핵심 하위 도메인은 복잡하고 자주 변하므로 초기에는 단순해 보이더라도 기능이 추가되면 다양한 규칙·엣지 케이스가 드러나 모델과 바운디드 컨텍스트의 경계를 다시 설계해야 하는 상황이 자주 발생한다.

도메인 지식이 불명확하거나 변화가 잦다면 초기에는 넓은 바운디드 컨텍스트로 시작하고, 시간이 지나 지식이 안정되면 더 작은 컨텍스트·마이크로서비스로 분해하는 것이 좋은 휴리스틱이다.

또한 도메인 지식은 시간이 지나면 문서 누락, 인력 이탈, 임시 기능 추가 등으로 쉽게 퇴보하기 때문에 지속적으로 관리해야 한다. 이러한 퇴보를 막고 도메인 지식을 재발견하는 효과적 도구가 이벤트스토밍 워크숍이다.

### 성장
성장은 시스템이 성공적으로 사용자 가치를 확장한다는 긍정적 신호이지만, 동시에 설계 결정을 재평가하지 않은 채 기능만 추가될 경우 코드베이스가 '커다란 진흙 덩어리'로 변할 위험을 초래한다.

DDD에서 중요한 것은 하위 도메인, 바운디드 컨텍스트, 밸류 오브젝트, 애그리게이트 등 경계를 지키는 설계 원칙인데, 무분별한 확장은 이 경계를 무너뜨린다. 따라서 성장으로 인해 발생하는 우발적 복잡성(과거 설계의 부작용)을 식별,제거하고, 본질적 복잡성은 DDD 도구와 관행으로 관리해야 한다.

이를 위해 도메인 분석 → 전략적 분해 → 모델 설계 → 구현의 과정을 성장 맥락에서도 다시 적용해 복잡성을 통제해야 한다.

#### 하위 도메인
하위 도메인의 경계는 처음부터 완벽히 찾기 어려우므로 실용적인 경계를 우선 식별해야 한다. 비즈니스가 성장하면 경계가 흐려지기 때문에 기존 하위 도메인을 재검토하고, 동일 데이터,유스케이스 기반의 응집도 휴리스틱으로 다시 분리 지점을 찾는 것이 중요하다.

세분화된 하위 도메인을 명확히 할수록 본질적 복잡성을 잘 관리할 수 있으며, 각 도메인에 맞는 기술적 해법 선택이 가능해진다. 특히 핵심 하위 도메인에서는 내부 하위 도메인을 적극적으로 추출해 전략적으로 중요한 부분에 집중해야 한다.

#### 바운디드 컨텍스트
바운디드 컨텍스트는 여러 문제를 각각 해결하기 위해 여러 모델을 분리해 사용하는 패턴이지만, 프로젝트가 성장하면서 초점을 잃고 다양한 로직이 섞이는 우발적 복잡성이 자주 발생한다.

따라서 하위 도메인처럼 바운디드 컨텍스트도 주기적으로 경계를 재검토하고, 특정 문제에 다시 집중하도록 컨텍스트를 추출,분리해 모델을 단순화해야 한다.

또한 여러 컨텍스트가 서로를 계속 호출해야만 작업이 완료되는 상황은 경계가 잘못 설계되었다는 신호이므로, 자율성을 높이는 방향으로 경계 재설계가 필요하다.

#### 애그리게이트
애그리게이트는 가능한 작게 유지하고, 비즈니스적으로 강한 일관성이 필요한 객체만 포함해야 한다. 그러나 시스템이 성장하면 기존 애그리게이트에 기능을 계속 덧붙여 불필요한 데이터와 로직이 함께 뭉치며 우발적 복잡성이 생기기 쉽다.

이때 기능을 별도의 전담 애그리게이트로 분리하면 원래 애그리게이트는 단순해지고, 바운디드 컨텍스트 전체도 더 명확해진다. 이런 리팩터링 과정에서 숨겨진 하위 모델이나 새로운 바운디드 컨텍스트가 드러나는 경우도 많다.

### 결론
기업은 경쟁력을 유지하기 위해 끊임없이 진화하고 스스로를 재창조하기 위해 노력한다.
- 비즈니스 도메이 발전함에 따라 설계를 발전시켜야 한다.
- 조직 구조의 변화가 팀 간의 의사소통, 바운디드 컨텍스트를 통합하는 방식에 영향을 준다는 것을 인식해야 한다.
- 비즈니스 도메인에 대해 배우는 과정은 계속 진행되는 과정이다.
    - 시간이 지남에 따라 더 많은 도메인 지식이 발견되면, 그것을 전략적, 전술적 설계 의사 결정을 발전시키는 데 활용해야 한다.

시스템의 성장에 따른 설계 조언
- 하위 도메인의 기능이 확장되면 더 나은 설계 의사결정을 내릴 수 있도록 더 세분화된 하위 도메인 경계를 식별하려고 노력해야 한다.
- 바운디드 컨텍스트에 포함된 모델이 특정 문제를 해결하는 데 중점을 두고 있는지 확인하라.
    - 여러 문제를 해결하는것을 허용하지 마라.
- 애그리게이트 경계가 가능한 한 작은지 확인하라. 확실하게 일관된 데이터의 휴리스틱을 사용하여 새 비즈니스 로직을 새 애그리게이트로 추출할 가능성을 탐지하라.