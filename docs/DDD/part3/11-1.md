## 진화하는 설계 의사결정
비즈니스 도메인의 요구사항에 잘 맞는 소프트웨어를 설계할 때, 변경 사항을 제대로 관리하지 않으면 아무리 정교하게 잘 설계했어도 결국 유지보수하고 개선하는 일은 고된 일이 될 것이다.

### 도메인 변경
세 가지 유형의 비즈니스 하위 도메인
- 핵심
    - 기업의 경쟁 우위를 확보하기 위해 경쟁자와 다르게 수행하는 활동
- 지원
    - 회사가 경쟁자와 다르게 행동하고 있지만 경쟁 우위를 제공하지 않는 활동
- 일반
    - 모든 회사가 같은 방식으로 하는 일

비즈니스 하위 도메인과 유형을 식별하는 것도 중요하지만 하위 도메인의 진화에 주의를 기울이는것도 중요하다.

변화의 예시

- 핵심 → 일반
    - 경쟁 우위로 간주 되었던 것이 모든 경쟁업체에서 사용할 수 있는 상품이 되었을 경우
- 일반 → 핵심
    - 상용 솔루션을 자체 구현으로 교체해서 경쟁우위를 확보하는 경우
    - 아마존의 경우 인프라를 관리하는 방법을 '재창조'하여 AWS를 만들었음
- 지원 → 일반
    - 사내 솔루션을 버리고 오픈 소스 솔루션을 연동하는 경우
- 지원 → 핵심
    - 회사에서 비용을 줄이거나 추가 수익을 창출하는 방식으로 지원 로직을 최적화하는 방법을 찾는 경우
    - 전조증상
        - 원래 지원 도메인은 회사 이익과 크게 관련이 없어 단순해야 한다. 그런데 로직이 복잡해진다면, 그 영역이 핵심 도메인의 성격을 띠기 시작하는 전조다.
- 핵심 → 지원
    - 복잡성에 비해 수익성이 없는 경우
- 일반 → 지원
    - 복잡성 대비 얻는 이점을 얻을수 없는 경우

### 전략적 설계 문제
하위 도메인의 유형 변화는 바운디드 컨텍스트와 통합 패턴 선택에 직접적인 영향을 미친다.
- 핵심 도메인은 충돌 방지 계층이나 오픈 호스트 서비스처럼 모델을 보호하는 패턴이 필요하다.
- 지원,일반 도메인은 분리형 노선 같은 느슨한 통합 패턴이 적합하다.

하위 도메인이 핵심으로 격상되면, 더 이상 기능을 여러 팀이 따로 개발할 수 없으며 필연적으로 사용자-제공자 관계를 기반으로 단일 팀에서만 구현해야 한다.

또한 도메인 유형 변화는 구현 전략에도 영향을 준다.
- 핵심 도메인: 사내에 깊이 있는 지식이 필요하므로 직접 개발해야 한다.
- 지원/일반 도메인: 외부 위탁 또는 새 인력의 훈련용으로도 활용 가능하다.

### 전술적 설계 문제
비즈니스가 어떻게 변화할지 예측할 수 없기 때문에, 구현 전략이 바뀌는 것은 자연스러운 일이다.
현재 상황에 가장 적합한 설계를 선택하고, 필요할 때 개선하는 유연성이 중요하다.

비즈니스 로직을 의도적으로 모델링하고, 가능한 설계 옵션과 그 차이점을 충분히 이해하고 있다면
현재의 디자인 패턴을 다른 패턴으로 무리 없이 마이그레이션할 수 있다.

- 트랜잭션 스크립트 → 액티브 레코드
    - 트랜잭션 스크립트에서 데이터 작업이 어려워지면 레코드 패턴으로 리팩터링
    - 복잡한 자료구조를 찾아 액티브 레코드 객체에 캡슐화
    - 데이터베이스에 직접 접근하는 대신 액티브 레코드를 사용하여 모델과 구조를 추상화
- 액티브 레코드 → 도메인 모델
    - 액티브 레코드를 조작하는 비즈니스 로직이 복잡해지고 불일치 및 중복 사례가 많아진다면 도메인 모델 패턴으로 리팩터링
    - 변환 순서
        1. 밸류 오브젝트 식별
        2. 자료구조를 분석하고 트랜잭션 경계 찾기
        3. 애그리게이트 경계 정의
            - 상태 변경 로직이 모여야 할 객체 경계를 찾는다.
            - 강한 일관성이 필요한 최소 데이터 범위를 애그리게이트로 설정한다.
            - 외부에는 루트만 공개하고 내부 객체는 캡슐화한다.
        4. 애그리게이트에 대해 루트 또는 퍼블릭 인터페이스의 엔드포인트를 식별한다.
- 도메인 모델 → 이벤트 소싱 도메인 모델
    - 애그리게이트 경계가 잘 잡혀 있다면, 상태를 직접 변경하는 대신 도메인 이벤트로 상태를 구성하는 방식으로 바꿔 이벤트 소싱 모델로 전환할 수 있다.
    - 가장 큰 어려움은 기존 이력 부재로, 과거 이벤트를 추론해 생성하거나 마이그레이션 전용 이벤트를 만들어 해결해야 한다.