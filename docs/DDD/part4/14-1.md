## 마이크로서비스
- 무분별한 마이크로서비스 아키텍처는 유연한 아키텍처 대신 분리하려 했던 원래의 모놀리식보다 더 깨지기 쉽고 투박하고 비싼 분산된 진흙 덩어리를 만든다.
- 마이크로서비스는 DDD 특히 바운디드 컨텍스트 패턴과 관련이 있을 때가 많다
    - 많은 사람들은 <b>바운디드 컨텍스트</b>와 <b>마이크로서비스</b>를 혼용하지만 다르다.

### 서비스란 무엇인가?
- 미리 정의된 인터페이스를 사용해 하나 이상의 역량에 접근하기 위한 매커니즘
    - <b>미리 정의된 인터페이스</b> : 서비스로부터 데이터를 넣고 빼는 모든 메커니즘
    - 예) 요청/응답 모델(동기식), 이벤트 제공/사용(비동기식)
- 서비스의 퍼블릭 인터페이스는 서비스 자체, 즉 서비스가 노출하는 기능을 정의한다.

### 마이크로서비스란 무엇인가?
- 자신의 마이크로 퍼블릭 인터페이스, 즉 마이크로 프론트 도어에 의해 정의되는 서비스
- 마이크로 퍼블릭 인터페이스의 이점
    - 단일 서비스의 기능과 그 서비스가 연동하는 다른 시스템의 구성요소 모두를 쉽게 이해할 수 있다.
    - 서비스의 기능을 줄이면 변경될 이유가 줄어들고 개발, 관리, 확장을 자율적으로 할 수 있다.

#### 서비스형 메서드: 완벽한 마이크로서비스?
- 서비스 인터페이스를 단일 메서드로 제한한다면 생기는 문제(서비스 하나에 메서드 하나)
    - 각각의 서비스가 자신의 DB를 제외한 다른 서비스의 DB에 접근하기 위한 퍼블릭 인터페이스가 없어서, 내부 통신을 위한 수많은 출입구를 추가해야 한다.
    - 서비스간의 연관관계가 복잡해진다.

서비스는 간단해지나 전체 시스템은 복잡해진다.

#### 설계 목표
마이크로서비스 아키텍처의 목표는 유연한 시스템을 만드는 것이다.

단일 컴포넌트에만 설계 노력을 집중하고 시스템의 나머지 연동을 무시하는것은 다음과 같은 시스템의 정의에 부적합하다.
- 함께 작동하는 연동된 것 또는 디바이스
- 특정 목적을 위해 함께 사용되는 컴퓨터 장비 및 프로그램

적절히 분리된 마이크로서비스 기반 시스템에서는 서로 연동하고 통신한다.

#### 시스템의 복잡성
- 로컬 복잡성
    - 각각의 개별 마이크로서비스의 복잡성
- 글로벌 복잡성
    - 전체 시스템의 복잡성

글로벌 복잡성을 줄이는 방법
- 모든 기능을 단일 모놀리식 서비스로 구현
    - 커다란 진흙 덩어리가 될 수 있으며, 로컬 복잡성은 최고 수준이 될 것이다.

로컬 복잡성만 최적화 하면 더 무시무시한 커다란 진흙 덩어리가 된다.

적절한 마이크로서비스 기반 시스템을 설계하려면 글로벌 복잡성과 로컬 복잡성 모두를 최적화 해야 한다.
- 어느 쪽이든 하나를 개별적으로 최적화하는 설계 목표를 가진 것은 로컬 최적화
- 글로벌 최적화는 두 복잡성의 균형을 최적화한다.

#### 깊은 서비스로서의 마이크로서비스
- <b>함수(function)</b>
    - 모듈이 해야 하는 일, 비즈니스 기능
- <b>로직(logic)</b>
    - 모듈의 비즈니스 로직, 비즈니스 기능 구현

존 우스터하우트의 모듈 평가
- 모듈을 사각형으로 평가한다.
- 사각형의 상단 면적은 퍼블릭 인터페이스의 복잡성을 나타낸다.
- 사각형의 깊이는 모듈의 복잡성을 나타낸다.
- 인터페이스는 적고, 구현 복잡성이 높은것이 좋다.
    - 간단한 퍼블릭 인터페이스가 복잡한 로직을 내포한다.
    - 깊이가 얕으면 복잡성을 내포하는 대신 전체 시스템에 우발적 복잡성을 발생시킨다.

#### 깊은 모듈로서의 마이크로서비스
깊은 모듈의 개념 차이
- 마이크로서비스 : 물리적인 경계
- 모듈 : 논리적 경계와 물리적 경계 모두 나타낸다.

두 개념과 하부의 설계 원칙은 동일하다.

시스템 복잡성 관점에서 깊은 모듈은 글로벌 복잡성을 줄여주는 반면, 얕은 모듈은 로컬 복잡성을 감싸지 않는 구성요소를 도입해야 해서 글로벌 복잡성이 증가한다.

마이크로서비스 지향 프로젝트가 실패하는 원인
- 얕은 서비스
- 서비스 하나에 코드 수 제한(몇 행 제한 등)
- 서비스를 수정하는 것보다 재작성을 쉽게 하려고 할 때
- '스시템'을 고려하지 않은 채 개별 시스템에 집중하는 경우

모놀리식 시스템을 서비스로 분리하면 변경에 드는 비용 감소
- 시스템이 마이크로서비스로 분리되기 때문에 비용이 줄어든다.
- 마이크로서비스를 임계치 이상으로 계속 분해하면 깊은 서비스가 얕은 서비스로 변한다.

### 도메인 주도 설계와 마이크로서비스의 경계
- 바운디드 컨텍스트 : 모델의 경계
- 하위 도메인 : 비즈니스 역량의 경계
- 애그리게이트, 밸류 오브젝트 : 트랜잭션 경계

#### 바운디드 컨텍스트
마이크로서비스는 사실상 바운디드 컨텍스트이다.
- 모두 물리적 경계이다.
- 단일 팀이 소유한다.
- 충돌하는 모델은 인터페이스가 복잡해지므로 구현할 수 없다.

바운디드 컨텍스트가 마이크로서비스라고 말할수는 없다.
- 바운디드 컨텍스트는 도메인 모델과 유비쿼터스 언어를 보호하기 위한 논리적 경계이다.
- 하나의 바운디드 컨텍스트는 반드시 독립 배포 단위일 필요는 없다.
- 여러 하위 도메인을 포함하는 큰 바운디드 컨텍스트도 유효한 설계가 될 수 있다.
- 이는 커다란 진흙 덩어리가 아니라, 일관된 도메인 모델을 유지하기 위한 선택일 수 있다.

시스템이 적절하지 않게 바운디드 컨텍스트를 분해하거나 마이크로서비스 임계치를 넘어서 분해된다면 각각 커다란 진흙 덩어리가 되거나 분산된 커다란 진흙 덩어리가 된다.

#### 애그리게이트
바운디드 컨텍스트는 가장 넓은 유효한 경계를 설정하지만, 애그리게이트 패턴의 경계는 가능한 한 좁게 설정한다.

애그리게이트를 여러 물리적 서비스 또는 바운디드 컨텍스트로 분해하는 것은 최적이 아닌 원치 않는 결과를 초래한다.

애그리게이트는 내부 비즈니스 규칙과 불변성, 로직의 복잡성을 감싸는 개별적인 비즈니스 기능 단위이다.
- 애그리게이트의 경계 또한 마이크로서비스의 경계를 결정한다고 여겨질 때가 많다.
    - 애그리게이트는 '개별 서비스'가 될 수 있지만, 마이크로서비스는 애그리게이트보다 더 큰 '컨텍스트 단위 서비스'다.
    - 애그리게이트 기준으로 마이크로서비스를 나누지 마라. 마이크로서비스는 컨텍스트 기준으로 생각하라.

애그리게이트가 자신의 하위 도메인에 있는 다른 비즈니스 엔티티와의 관계가 강할수록 얕은 개별 서비스가 된다.
- 다른 애그리게이트에 자신의 밸류 오브젝트를 공유한다.
- 애그리게이트의 비즈니스 로직 변경이 하위 도메인의 다른 구성요소에 영향을 주거나, 반대의 경우가 발생할 경우

#### 하위 도메인
마이크로서비스 설계의 안전한 휴리스틱은 비즈니스 하위 도메인의 경계와 서비스를 일치시키는 것이다. 하위 도메인은 "어떻게"가 아닌 "무엇을" 하는 비즈니스 역량을 나타내며, 응집된 유스케이스와 공통 도메인 모델을 가진 깊은 모듈을 형성한다.  

이러한 특성 때문에 하위 도메인은 마이크로서비스 경계로 적합하지만, 조직 구조나 비기능 요구사항에 따라 더 넓은 바운디드 컨텍스트나 애그리게이트 단위가 더 적절한 경우도 있다.

### 마이크로서비스의 퍼블릭 인터페이스 압축하기
도메인 주도 설계는 서비스의 경계를 찾는 데 쓰일 뿐만 아니라, 서비스를 깊게 만드는 데도 도움을 준다.

#### 오픈 호스트 서비스
오픈 호스트 서비스
- 비즈니스 도메인의 바운디드 컨텍스트 모델을 시스템의 다른 구성요소와 연동하는 데 사용되는 모델과 분리해준다.

연동 지향 모델인 공표된 언어를 도입하면 시스템의 글로벌 복잡성이 줄어든다.
- 서비스 사용자에게 영향을 미치지 않고 서비스의 구현을 발전시킬 수 있다.
    - 새로운 구현 모델은 기존의 공표된 언어로 변환될 수 있다.
- 좀 더 제한된 모델을 노출한다.
    - 연동에 필요한 요구사항에 맞게 설계된다.
    - 서비스 사용자와 상관없는 구현의 복잡성을 감춰준다.

동일한 구현(로직)에 대한 더 간단한 퍼블릭 인터페이스(기능)를 갖게 되면 서비스가 더 깊이있어진다.

#### 충돌 방지 계층
서비스를 다른 바운디드 컨텍스트와 연동할 때 복잡성을 줄여준다.

ACL 서비스는 바운디드 컨텍스트를 사용하는 로컬 복잡성과 시스템의 글로벌 복잡성을 모두 줄여준다.
- ACL 서비스 덕분에 바운디드 컨텍스트를 사용할 때의 비즈니스 복잡성과 연동할 때의 복잡성이 줄어든다.
    - 연동의 복잡성은 ACL이 담당한다.
    - ACL 서비스는 바운디드 컨텍스트가 제공하는 서비스의 복잡성을 노출하지 않는 연동 지향적인 모델이다.
    - 바운디드 컨텍스트의 사용자는 압축된 퍼블릭 인터페이스와 좀 더 편리하게 동작한다.

### 결론
- 마이크로서비스 기반 아키텍처 스타일은 도메인 주도 설계와 깊이 연결되어 있다.
- 모든 마이크로서비스는 바운디드 컨텍스트다.
- 그러나 모든 바운디드 컨텍스트가 반드시 마이크로서비스인것은 아니다.
    - 마이크로서비스는 서비스의 가장 작은 유효한 경계를 정의한다.
    - 바운디드 컨텍스트는 모델 전반의 일관성을 보호하고 가장 넓은 유효한 경계를 나타낸다.

바운디드 컨텍스트보다 넓은 경계를 정의하면 커다란 진흙 덩어리를 만들고, 마이크로서비스보다 작은 경계는 분산된 커다란 진흙 덩어리를 만든다.