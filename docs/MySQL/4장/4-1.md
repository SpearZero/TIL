- MySQL 엔진
    - 사람의 머리 역할
- 스토리지 엔진
    - 손발 역할
    - 핸들러 API를 만족하면 누구든지 스토리지 엔진을 구현해서 MySQL 서버에 추가해서 사용할 수 있다. 

## MySQL 엔진 아키텍처

### MySQL의 전체 구조
MySQL 엔진과 스토리지 엔진으로 구분할 수 있다.
- MySQL 엔진
    - 쿼리 파서, 옵티마이저 등
- 스토리지 엔진

#### MySQL 엔진
- 커넥션 핸들러
    - 클라이언트로부터의 접속 및 쿼리 요청을 처리함
- SQL 파서, 전처리기
- 옵티마이저
    - 쿼리의 최적화된 실행을 위해 사용

요청된 SQL 문장을 분석하거나 최적화 하는 등의 기능을 담당

#### 스토리지 엔진
실제 데이터를 디스크 스토리지에 저장하거나 디스크 스토리지로부터 데이터를 읽어오는 부분을 전담한다.

MySQL 엔진은 하나지만 스토리지 엔진은 여러개다.

```sql
CREATE TABLE test_table (fd1 INT, fd2 INT) ENGINE=INNODB;
```
해당 예시에서 스토리지 엔진은 InnoDB 이다.
- INSERT, UPDATE, DELETE, SELECT 등의 작업을 InnoDB가 처리한다.

스토리지 엔진은 성능 향상을 위한 기능이 존재
- MyISAM
    - 키 캐시
- InnoDB
    - 버퍼 풀

#### 핸들러 API
- 핸들러(Handler) 요청
    - MySQL 엔진의 쿼리 실행기에서 데이터를 쓰거나 읽어야 할 때, 각 스토리지 엔진에 쓰기 또는 읽기를 요청하는데 이러한 요청을 핸들러 요청이라 함
- 핸들러 API
    - 핸들러 요청에 사용하는 API

### MySQL 스레딩 구조

MySQL은 프로세스 기반이 아니라 스레드 기반으로 동작
- 포그라운드(Foreground) 스레드
- 백그라운드(Background) 스레드

라이센스 별 스레드 동작
- MySQL 커뮤니티 에디션
    - 전통적으로 가지고 있던 스레드 모델 사용
        - 커넥션 별로 포그라운드 스레드가 하나씩 생성되고 할당 
- MySQL 엔터프라이즈 에디션, Percona MySQL 서버
    - 스레드 풀
        - 커넥션과 포그라운드 스레드가 1:1 관계가 아닌 하나의 스레드가 여러개의 커넥션 요청을 전담

#### 포그라운드 스레드(클라이언트 스레드)
최소한 MySQL 서버에 접속된 클라이언트 수 만큼 존재
- 클라이언트 사용자가 요청하는 쿼리 문장 처리
- 클라이언트 사용자가 작업을 마치고 커넥션을 종료하면 해당 커넥션을 담당하던 스레드는 스레드 캐시(Thread Cache)로 되돌아 간다.
- 스레드 캐시에 일정 수 이상의 대기중인 스레드가 있으면 캐시에 넣지 않고 스레드를 종료시킨다.
    - thread_cache_size 시스템 변수로 최대 스레드 개수를 할당

포그라운드 스레드의 역할
- 데이터를 MySQL의 데이터 버퍼나 캐시로부터 가져온다.
    - 버퍼나 캐시에 없는 경우에는 직접 디스크의 데이터나 인덱스 파일로부터 데이터를 읽어와서 작업을 처리한다.
- MyISAM 테이블은 디스크 쓰기 작업까지 포그라운드 스레드가 처리
- InnoDB 테이블은 데이터 버퍼나 캐시까지만 포그라운드 스레드가 처리하고, 나머지 버퍼로부터 디스크까지 기록하는 작업은 백그라운드 스레드가 처리한다.

MySQL에서는 사용자 스레드와 포그라운드 스레드를 같은 의미로 사용한다.

#### 백그라운드 스레드
InnoDB는 다음과 같은 여러가지 작업을 수행한다. (MyISAM의 경우 거의 해당하지 않음)
- 인서트 버퍼(Insert Buffer)를 병합하는 스레드
- 로그를 디스크로 기록하는 스레드
- InnoDB 버퍼 풀의 데이터를 디스크에 기록하는 스레드
- 데이터를 버퍼로 읽어 오는 스레드
- 잠금이나 데드락을 모니터링 하는 스레드

백그라운드 스레드의 기능중 중요한 것
- 로그 스레드(Log thread)
- 쓰기 스레드(Write thread)
    - 버퍼의 데이터를 디스크로 내려쓰는 작업을 처리
    - innodb_write_io_threads, innodb_read_io_threads 시스템 변수로 스레드 설정
    - 데이터를 읽는 작업은 주로 클라이언트 스레드에서 처리하므로 많은 설정이 필요하지 않음
    - 쓰기 스레드는 아주 많은 작업을 백그라운드 스레드에서 처리한다.

데이터의 쓰기 작업은 지연(버퍼링)될 수 있지만, 읽기 작업은 지연될 수 없다.
- InnoDB도 이러한 방식으로 데이터를 처리한다.

반면, MyISAM은 사용자 스레드가 쓰기 작업까지 함께 처리한다.
- 일반적인 쿼리는 쓰기 버퍼링 기능을 사용하지 못함

### 메모리 할당 및 사용 구조

#### 글로벌 메모리 영역
일반적으로 클라이언트 수와 무관하게 하나의 메모리 공간만 할당된다.
- 필요에 따라 2개 이상의 메모리 공간이 할당될 수 있다.
- 모든 스레드에 의해 공유된다.

대표적인 글로벌 메모리 영역
- 테이블 캐시
- InnoDB 버퍼 풀
- InnoDB 어댑티브 해시 인덱스
- InnoDB 리두 로그 버퍼

#### 로컬 메모리 영역
- 세션 메모리 영역이라고도 표현한다.
- 클라이언트 스레드가 쿼리를 처리하는데 사용하는 메모리 영역
    - 클라이언트 메모리 영역 또는 세션 메모리 영역이라고 한다.
- 클라이언트 스레드별로 독립적으로 할당되며 공유되지 않음
- 필요하지 않으면 메모리 공간이 할당되지 않을 수 있음
- 커넥션이 열려 있는 동안 계속 할당된 상태로 남아 있는 공간이 있으며, 그렇지 않고 쿼리를 실행하는 순간에만 할당했다가 다시 해제하는 공간이 있다.

대표적인 로컬 메모리 영역
- 정렬 버퍼(Sort Buffer)
- 조인 버퍼
- 바이너리 로그 캐시
- 네트워크 버퍼

### 쿼리 실행 구조

#### 쿼리 파서
- 사용자 요청으로 들어온 쿼리 문장을 토큰으로 분리해 트리 형태의 구조로 만들어 내는 작업
- 쿼리 문장의 기본 문법 오류는 이 과정에서 발견되고 사용자에게 오류 메시지를 전달

#### 전처리기
- 파서 트리를 기반으로 쿼리 문장에 구조적인 문제점이 있는지 확인
- 각 토큰을 테이블 이름이나 칼럼 이름, 또는 내장 함수와 같은 객체를 매핑해 해당 객체의 존재 여부와 객체의 접근 권한 등을 확인하는 과정
- 존재하지 않거나 권한상 사용할수 없는 개체의 토큰은 이 단계에서 걸러진다.

#### 옵티마이저
- 사용자의 요청으로 들어온 쿼리 문장을 저렴한 비용으로 가장 빠르게 처리할지를 결정하는 역할

#### 실행 엔진
- 만들어진 계획대로 각 핸들러에게 요청해서 받은 결과를 또 다른 핸들러 요청의 입력으로 연결하는 역할을 수행

#### 핸들러(스토리지 엔진)
- MySQL 서버의 가장 밑단에서 MySQL 실행 엔진의 요청에 따라 데이터를 디스크로 저장하고 디스크로부터 읽어오는 역할을 담당한다.
- 핸들러는 스토리지 엔진을 의미한다.
    - MyISAM의 경우 핸들러가 MyISAM 스토리지 엔진이 된다.
    - InnoDB의 경우 핸들러가 InnoDB 스토리지 엔진이 된다.

### 쿼리 캐시
MySQL 8.0에서 쿼리 캐시의 기능이 제거됨
- 캐시이므로 빠른 성능을 보였지만, 테이블의 데이터 변경에 대해 캐시에 저장된 결과 중에서 변경된 테이블과 관련된 것들을 모두 삭제해야 하는 문제가 발생함
    - 심각한 동시 처리 성능 저하를 유발함

### 스레드 풀
MySQL의 커뮤니티 에디션은 스레드 풀을 제공하지 않는다.(엔터프라이즈 에디션은 제공)

Percona Server의 스레드 풀
- 플러그인 형태로 작동
- 사용자의 요청을 처리하는 스레드 개수를 줄여서 동시 처리되는 요청이 많다 하더라도 MySQL 서버의 CPU가 제한된 개수의 스레드 처리에만 집중할 수 있게 해서 서버의 자원 소모를 줄이는 것이 목적
- CPU코어의 개수와 스레드 수를 맞추는 것이 CPU 프로세서 친화도를 높이는 데 좋다.

### 트랜잭션 지원 메타데이터
메타데이터 또는 데이터 딕셔너리
- 데이터베이스 서버에서 테이블의 구조 정보와 스토어드 프로그램 등의 정보를 말한다.

MySQL 5.7 이전
- 테이블의 구조를 FRM 파일에 저장하고 스토어드 프로그램을(TRN, TRG, PAR, ...) 기반으로 관리
- 파일 기반의 메타데이터는 생성 및 변경이 트랜잭션을 지원하지 않음
    - MySQL 서버가 종료되면 일관되지 않은 상태로 남는 문제가 발생

MySQL 8.0 이후
- 테이블의 구조 정보나 스토어드 프로그램의 코드 관련 정보를 모두 InnoDB의 테이블에 저장
- MySQL 서버가 작동하는데 기본적으로 필요한 테이블(시스템 테이블)을 모두 InnoDB 스토리지 엔진을 사용하도록 개선
    - 시스템 테이블 : 인증과 권한에 관련된 테이블 등
- 시스템 테이블과 데이터 딕셔너리 정보를 모두 모아서 mysql DB에 저장
    - mysql DB는 통째로 mysql.ibd라는 이름의 테이블스페이스에 저장
- 시스템 테이블과 데이터 딕셔너리 테이블이 모두 트랜잭션 기반의 InnoDB에 저장
    - 스키마 변경이 완전한 성공 또는 완전한 실패로 정리된다.
- InnoDB 의외에 스토리지 엔진은 SDI(Serialized Dictionary Information) 파일을 사용한다.
    - 직렬화를 위한 포맷
    - *.sdi 파일 존재 기존의 *.FRM 파일과 동일한 역할
    - InnoDB 테이블들의 구조도 SDI 파일로 변환 가능 하다.