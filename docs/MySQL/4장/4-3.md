## InnoDB 스토리지 엔진 아키텍처

### InnoDB 버퍼 풀
InnoDB의 가장 핵심적인 부분
- 디스크의 데이터 파일이나 인덱스 정보를 메모리에 캐시해 두는 공간
- 쓰기 작업을 지연시켜 일괄 작업으로 처리할 수 있게 해주는 버퍼 역할도 같이 한다.
- 데이터를 변경하는 쿼리(INSERT, UPDATE, DELETE)는 랜덤한 디스크 작업을 발생시키는데 버퍼풀이 이러한 변경된 데이터를 모아서 처리하면 랜덤한 디스크 작업의 횟수를 줄일 수 있다.

#### 버퍼 풀의 크기 설정
운영체제와 각 클라이언트 스레드가 사용할 메모리도 고려하여 버퍼풀의 크기를 설정해야 한다.
- MySQL 서버 내에서 메모리를 필요로 하는 부분은 크게 없지만 독특한 경우 레코드 버퍼가 상당한 메모리를 사용한다.

MySQL 5.7 버전부터는 InnoDB 버퍼 풀의 크기를 동적으로 조절할 수 있게 개선됐다.

InnoDB 버퍼 풀은 innodb_buffer_pool_size 시스템 변수로 크기를 설정할 수 있다.
- 버퍼 풀의 크기 변경은 중요한 변경이므로 MySQL 서버가 한가한 시점에 진행하는 것이 좋다.
- InnoDB 버퍼 풀의 크기를 늘리는 것은 시스템 영향도가 크지 않지만, 줄이는 작업은 서비스 영향도가 매우 크다.
- InnoDB 버퍼 풀은 내부적으로 128MB 청크 단위로 관리된다. 이는 버퍼 풀의 크기를 줄이거나 늘리기 위한 단위 크기로 사용된다.

innodb_buffer_pool_instances 시스템 변수
- 버퍼 풀 전체를 관리하는 잠금(세마포어)로 인한 내부 잠금 경합을 줄이기 위해 사용된다.
- 버퍼 풀을 여러 개로 분리해서 관리할 수 있다.
    - 잠금(세마포어) 자체도 경합이 분산되는 효과를 낸다.
    - 각 버퍼 풀을 버퍼 풀 인스턴스라고 표현한다.
- 버퍼 풀 인스턴스는 기본적으로 8개로 초기화 된다.
    - 버퍼 풀의 메모리 크기가 1GB 미만이면 버퍼 풀 인스턴스는 1개만 생성된다.

#### 버퍼 풀의 구조
InnoDB 스토리지 엔진은 버퍼 풀의 공간을 페이지 크기(innodb_page_size 시스템 변수에 설정)의 조각으로 쪼개어 InnoDB 스토리지 엔진이 데이터를 필요로 할 때 해당 데이터 페이지를 읽어서 각 조각에 저장한다.

버퍼 풀의 페이지 크기 조각을 관리하기 위해 InnoDB 스토리지 엔진이 관리하는 자료구조
- LRU(Least Recently Used) 리스트
    - LRU와 MRU(Most Recentlry Used) 리스트가 결합된 형태
    - 디스크로부터 한 번 읽어온 페이지를 최대한 오랫동안 InnoDB 버퍼풀의 메모리에 유지해서 디스크 읽기를 최소화 하는 것이 목적
    - 데이터 페이지가 자주 사용되면 버퍼 풀의 MRU 영역에서 계속 살아남고, 자주 사용되지 않으면 LRU의 끝으로 밀려나 InnoDB 버퍼 풀에서 제거된다.
    - 자주 접근되는 페이지의 인덱스 키는 어댑티브 해시 인덱스에 추가된다.
- 플러시(Flush) 리스트
    - 디스크로 동기화 되지 않은 데이터를 가진 데이터 페이지(더티 페이지)의 변경 시점 기준의 페이지 목록을 관리
    - 변경이 가해진 페이지는 특정 시점에 디스크로 기록되어야 한다.
    - 데이터가 변경되면 InnoDB는 변경 내용을 리두 로그에 기록하고 버퍼 풀의 데이터 페이지에도 변경 내용을 반영한다.
        - 리두 로그의 각 엔트리는 특정 데이터 페이지와 연결된다.
- 프리(Free) 리스트
    - 비어 있는 페이지들의 목록, 사용자의 쿼리가 새롭게 디스크의 데이터 페이지를 읽어와야 하는 경우 사용

#### 버퍼 풀과 리두 로그
버퍼 풀은 데이터 캐시와 쓰기 버퍼링이라는 두 가지 용도가 있다.
- 버퍼 풀의 메모리 공간을 늘리는 것은 데이터의 캐시 기능만 향상시키는 것이다.
- InnoDB 버퍼 풀의 쓰기 버퍼링 기능까지 향상 시키려면 InnoDB 버퍼 풀과 리두 로그와의 관계를 이해 해야 한다.

InnoDB의 버퍼 풀
- 디스크에서 읽은 상태로 전혀 변경되지 않은 클린 페이지(Clean Page) 존재
- 변경된 데이터를 가진 더티 페이지(Dirty Page) 존재
    - 더티 페이지는 디스크와 데이터 상태가 다르기 때문에 언젠가는 디스크로 기록되어야 한다.

InnoDB 스토리지 엔진에서 리두 로그는 1개 이상의 고정 크기 파일을 연결해서 순환 고리 처럼 사용한다.
- 따라서 더티 페이지는 버퍼 풀에 무한정 머무를 수 없음(순환 하기 때문에)
- 증가되는 리두 로그 포지션은 LSN(Log Sequence Number)라고 한다.
    - 체크포인트 이벤트는 리두 로그와 버퍼 풀의 더티 페이지를 디스크로 동기화 한다.
- 리두 로그에서 재사용 불가능한 공간을 활성 리두 로그(Active Redo Log)라고 한다.
    - 가장 최근 체크포인트 지점의 LSN이 활성 리두 로그 공간의 시작점이다.
- 체크 포인트 에이지
    - 활성 리두 로그 공간의 크기를 말한다.
    - 가장 최근 체크포인트의 LSN과 마지막 리두 로그 엔트리의 LSN의 차이를 말한다.

더티 페이지는 특정 리두 로그 엔트리와 관계를 가진다.
- 체크포인트가 발생하면 체크포인트 LSN(Log Sequence Number) 보다 작은 리두 로그 엔트리와 관련된 더티 페이지는 모두 디스크로 동기화 되어야 한다.
- 체크포인트 LSN보다 작은 LSN 값을 가진 리두 로그 엔트리도 디스크로 동기화 돼야 한다.

버퍼 풀과 리두 로그 파일 크기의 관계
- 버퍼 풀이 크고 리두 로그 파일의 크기가 작은 경우
    - 쓰기 버퍼링의 효과를 보지 못한다. (리두 로그 파일의 크기가 작으므로)
- 버퍼 풀이 작고 리두 로그 파일의 크기가 큰 경우
    - 버퍼 풀이 작으므로 최대 허용 가능한 더티 페이지의 크기가 작아진다.
    - 더티 페이지의 비율이 높으면 갑작스러운 디스크 쓰기가 발생할 가능성이 높다.

#### 버퍼 풀 플러시(Buffer Pool Flush)
- MySQL 5.6 버전까지 InnoDB 스토리지 더티 페이지의 기능이 부드럽게 처리되지 않음
    - 예를 들어, 갑작 스러운 디스크 기록이 폭증하여 MySQL 서버의 사용자 쿼리 처리 성능에 영향을 받는 경우가 많았음
- MySQL 5.7 버전을 거쳐서 MySQL 8.0 버전으로 업그레이드 되면서 대부분의 서비스에서는 더티 페이지를 디스크에 동기화 하는 부분(더티 페이지 플러시)에서 예전과 같은 디스크 쓰기 폭증 현상은 발생하지 않음

디스크로 기록되지 않는 더티 페이지들을 성능상의 악영향 없이 디스크에 동기화하기 위해 다음과 같이 2개의 플러시 기능을 백그라운드로 실행
- 플러시 리스트 플러시
- LRU 리스트 플러시

##### 플러시 리스트 플러시
InnoDB 스토리지 엔진은 주기적으로 플러시 리스트 플러시 함수를 호출해서 플러시 리스트에서 오래전에 변경된 데이터 페이지 순서대로 디스크에 동기화하는 작업을 수행

##### LRU 리스트 플러시
InnoDB 스토리지 엔진은 LRU 리스트에서 사용 빈도가 낮은 데이터 페이지들을 제거해서 새로운 페이지들을 읽어올 공간을 만들어야 하는데, 이를 위해 LRU 리스트 플러시 함수가 사용된다.
- 페이지 스캔시 더티 페이지는 디스크에 동기화 하고, 클린 페이지는 즉시 프리 리스트로 페이지를 옮긴다.

#### 버퍼풀 상태 백업 및 복구
디스크의 데이터가 버퍼 풀에 적재되어 있는 상태를 워밍업이라고 표현한다.
- 버퍼 풀이 잘 워밍업된 상태에서는 그렇지 않은 경우보다 몇십 배의 쿼리 처리 속도를 보이는 것이 일반적이다.

MySQL 5.6 버전부터 버퍼 풀 덤프 및 적재 기능이 도입되었다.
- 버퍼 풀의 상태를 백업할 수 있다.
- MySQL 서버를 다시 시작하면 innodb_buffer_pool_load_now 시스템 변수를 이용해 백업된 버퍼 풀의 상태를 다시 복구할 수 있다.
- 버퍼 풀의 백업은 빨리 완료되지만, 백업된 버퍼 풀의 내용을 다시 버퍼 풀로 복구하는 과정은 InnoDB 버퍼 풀의 크기에 따라 상당한 시간이 걸릴 수 있다.
    - 버퍼 풀 복구 작업은 상당히 많은 디스크 읽기를 필요로 하기 때문에 버퍼 폴 복구가 실행 중인 상태에서 서비스를 재개하는 것은 좋지 않은 선택일 수 있다.
    - innodb_buffer_pool_load_abort 시스템 변수를 이용해 버퍼 풀 적재 작업을 멈출 수 있다.
- 버퍼 풀의 백업과 복구를 자동화 하려면 다음과 같은 설정 사용
    - innodb_buffer_pool_dumpt_at_shutdown
    - innodb_buffer_pool_load_at_startup
    - 위의 설정들을 MySQL 서버의 설정 파일에 넣어두면 된다.

#### 버퍼 풀의 적재 내용 확인
MySQL 8.0 버전에서 information_schema 데이터베이스에 innodb_cached_indexes 테이블이 추가 되었는데, 이 테이블을 이용하면 인덱스별로 데이터 페이지가 얼마나 InnoDB 버퍼 풀에 적재돼 있는지 확인할 수 있다.