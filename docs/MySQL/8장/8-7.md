## 유니크 인덱스
- 유니크는 인덱스보다는 제약조건에 가깝다.
- MySQL에서는 인덱스 없이 유니크 제약만 설정할 수 없음
- 유니크 인덱스에는 NULL 값이 저장될 수 있다.
- MySQL에서 프라이머리 키는 기본적으로 NULL을 허용하지 않는 유니크 속성이 자동으로 부여
- MyISAM, MEMORY 테이블에서는 프라이머리 키는 NULL이 허용되지 않는 유니크 인덱스와 같다.

### 유니크 인덱스와 일반 세컨더리 인덱스 비교
인덱스 구조상으로는 차이점이 없다.

#### 인덱스 읽기
- 성능상의 차이가 별로 없다.
    - 읽어야 할 레코드의 건수가 같다면 성능상의 차이가 미미하다.
- 세컨더리 인덱스에서 한 번 더 해야 하는 작업은 디스크 읽기가 아니라 CPU에서 칼럼값을 비교하는 작업이다.
- 하나의 값으 검색한느 경우, 유니크 인덱스와 일반 세컨더리 인덱스는 사용되는 실행 계획이 다르지만, 이는 인덱스의 성격이 유니크한지 아닌지에 따른 차이일 뿐 큰 차이는 없다.

#### 인덱스 쓰기
- 새로운 레코드가 INSERT되거나 인덱스 칼럼의 값이 변경되는 경우 인덱스 쓰기 작업이 필요
- 유니크 인덱스의 키 값을 쓸 때는 중복을 검사하는 과정이 필요하다.
    - 따라서 세컨더리 인덱스보다 느리다.
- MySQL에서는 유니크 인덱스에 중복된 값을 체크할 때 읽기 잠금을 사용하고, 쓰기를 할 때는 쓰기 잠금을 사용한다.
    - 데드락이 빈번하게 발생한다.
- 세컨더리 인덱스는 체인지 버퍼를 사용할 수 있지만, 유니크 인덱스는 사용할 수 없다.
- 일반적으로 유니크 인덱스는 일반 세컨더리 인덱스보다 변경 작업이 더 느리다.

#### 유니크 인덱스 사용 시 주의사항
- 성능이 좋아질 것으로 생각하고 불필요하게 유니크 인덱스를 생성하지 않는 것이 좋다.
- MySQL의 유니크 인덱스는 일반 다른 인덱스와 같은 역할을 하므로 중복해서 인덱스를 생성할 필요가 없다. (같은 칼럼에 대해서)
- 같은 칼럼에 대해 프라이머리 키와 유니크 인덱스를 동일하게 생성하는 것도 불필요한 중복이다.

## 외래 키
- InnoDB 스토리지 엔진에서만 생성할 수 있다.
- 외래키 제약이 설정되면 자동으로 연관되는 테이블의 칼럼에 인덱스까지 생성된다.
- 외래키가 제거되지 않은 상태에서는 자동으로 생성된 인덱스를 삭제할 수 없다.

InnoDB 외래키 관리에서 중요한 두 가지 속성
- 테이블의 변경(쓰기 잠금)이 발생하는 경우에만 잠금 경합(잠금 대기)이 발생한다.
- 외래키와 연관되지 않은 칼럼의 변경은 최대한 잠금 경합(잠금 대기)을 발생시키지 않는다.

#### 자식 테이블의 변경이 대기하는 경우
1. 부모 테이블에서 id가 2인 레코드를 UPDATE 진행
2. 자식 테이블에서 외래키 칼럼을 2로 변경하는 쿼리 실행
    - 이 때, 부모 테이블의 변경 작업이 완료될 때 까지 대기
3. 부모 테이블의 커넥션에서 ROLLBACK이나 COMMIT으로 트랜잭션이 종료
4. 자식 테이블의 작업이 즉시 처리된다.

자식 테이블의 외래 키 칼럼의 변경(INSERT, UPDATE)는 부모 테이블의 확인이 필요한데, 이 상태에서 부모 테이블의 해당 레코드가 쓰기 잠금이 걸려 있으면 해당 쓰기 잠금이 해제될 때 까지 기다리게 된다.

자식 테이블의 외래키가 아닌 칼럼의 변경은 외래키로 인한 잠금이 발생하지 않는다.

#### 부모 테이블의 변경 작업이 대기하는 경우
1. 부모키 1을 참조하는 자식 테이블의 레코드 변경
    - 이 때 쓰기 잠금 획득
2. 부모 테이블에서 id가 1인 레코드 삭제
    - 자식 테이블의 레코드에 대한 쓰기 잠금이 해제될 때까지 기다려야 한다.
    - 자식 테이블이 생성될 때 정의된 외래키의 특성(ON DELETE CASCADE) 때문에 부모 레코드가 삭제되면 자식 레코드도 동시에 삭제되는 식으로 작동하기 때문

외래키 생성시 잠금 경합까지 고려해 모델링을 진행해야 한다.
- 물리적 외래키 생성시 자식 테이블에 레코드가 추가되는 경우 해당 참조키가 부모 테이블에 있는지 확인해야 한다.
- 물리적 외래키의 고려 사항은 체크 작업이 아닌, 체크를 위해 연관 테이블에 읽기 잠금을 걸어야 한다는 것이 중요하다.
    - 이렇게 잠금이 다른 테이블로 확장되면 그만큼 전체적으로 쿼리의 동시 처리에 영향을 미친다.